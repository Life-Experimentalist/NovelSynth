(()=>{"use strict";class e{findContentArea(){const e=["main",'[role="main"]',"#content",".content","#main",".main","article",".post-content",".entry-content",".story-text",".chapter-content"];for(const t of e){const e=document.querySelector(t);if(e&&this.isValidContentArea(e))return e}return this.findLargestTextContainer()}extractContent(e){const t=e.cloneNode(!0);return this.removeUnwantedElements(t),this.extractFormattedText(t)}extractTitle(){const e=["h1",".title",".chapter-title",".post-title",".entry-title"];for(const t of e){const e=document.querySelector(t);if(e&&e.textContent?.trim())return e.textContent.trim()}return document.title}getChapterNavigation(){return{hasPrevious:!1,hasNext:!1,currentChapter:1,totalChapters:1}}formatAfterEnhancement(e){this.addEnhancementMarkers(e)}isValidContentArea(e){if((e.textContent||"").trim().split(/\s+/).length<50)return!1;const t=e.classList.toString().toLowerCase();return!["nav","sidebar","footer","header","menu"].some((e=>t.includes(e)))}findLargestTextContainer(){const e=document.querySelectorAll("div, section, article");let t=null,n=0;return e.forEach((e=>{const r=(e.textContent||"").trim().split(/\s+/).length;r>n&&this.isValidContentArea(e)&&(t=e,n=r)})),t}removeUnwantedElements(e){["script","style","nav",".navigation",".nav",".sidebar",".footer",".header",".advertisement",".ads",".social-media",".comments",".author-note"].forEach((t=>{e.querySelectorAll(t).forEach((e=>e.remove()))}))}extractFormattedText(e){return e.querySelectorAll("p, div, br, h1, h2, h3, h4, h5, h6").forEach((e=>{"BR"===e.tagName?e.replaceWith("\n"):e.appendChild(document.createTextNode("\n"))})),e.textContent||""}addEnhancementMarkers(e){e.classList.add("novelsynth-enhanced"),e.setAttribute("data-enhanced","true")}}class t extends e{extractTitle(){return document.title}getChapterNavigation(){try{const e=document.getElementById("chap_select");if(e){const t=e.querySelectorAll("option"),n=e.selectedIndex;return{hasPrevious:n>0,hasNext:n<t.length-1,currentChapter:n+1,totalChapters:t.length}}}catch(e){console.error("Error getting chapter navigation:",e)}return super.getChapterNavigation()}formatAfterEnhancement(e){super.formatAfterEnhancement(e),e.style.fontFamily="Verdana, Arial, sans-serif",e.style.fontSize="14px",e.style.lineHeight="1.6"}findContentArea(){const e=["#storytext",".storytext","#story_container .story_text",".story_text"];for(const t of e){const e=document.querySelector(t);if(e)return e}return super.findContentArea()}}class n extends e{findContentArea(){const e=document.querySelector(".text-chapter");if(e)return e;const t=["#arrticle",".story"];for(const e of t){const t=document.querySelector(e);if(t&&t.innerText.trim().length>1e3)return t}return super.findContentArea()}extractTitle(){const e=document.querySelector("h1.title");if(e)return e.textContent?.trim()||"";const t=[".story-title",".chapter-title"];for(const e of t){const t=document.querySelector(e);if(t&&t.textContent?.trim())return t.textContent.trim()}return document.title}extractContent(e){if(!e)return"";const t=e.cloneNode(!0);t.querySelectorAll("h1, h2, h3.title, .story-title, .chapter-title").forEach((e=>{e.remove()}));let n=t.innerText.trim().replace(/\n\s+/g,"\n").replace(/\s{2,}/g," ");const r=this.extractTitle().split(/[:\-–—]/),a=n.split("\n");return[...a.slice(0,5).filter((e=>{const t=e.trim();if(""===t)return!0;for(const e of r){const n=e.trim();if(n.length>3&&(t===n||t.startsWith(`${n}:`)||t.startsWith(`${n} -`)))return!1}return!/^[A-Z][a-z]+(\s+[A-Z][a-z]+)*$/.test(t)})),...a.slice(5)].join("\n")}isChapterPage(){if(window.location.pathname.includes("/chapter-")||window.location.pathname.includes("/read-"))return!0;const e=["#arrticle",".text-chapter",".story"];for(const t of e){const e=document.querySelector(t);if(e&&e.textContent&&e.textContent.trim().length>1e3)return!0}const t=["h1.title",".story-title",".chapter-title"];for(const e of t){const t=document.querySelector(e);if(t&&t.textContent?.trim()){const e=t.textContent.toLowerCase();if(e.includes("chapter")||e.includes("volume"))return!0}}return!1}getChapterNavigation(){try{const e=document.querySelector(".options-left");if(e&&e.textContent){const t=e.textContent.match(/Chapter (\d+)/i),n=document.querySelector(".prev-chap"),r=document.querySelector(".next-chap");if(t)return{hasPrevious:null!==n,hasNext:null!==r,currentChapter:parseInt(t[1],10),totalChapters:0}}}catch(e){console.error("Error getting chapter navigation:",e)}return super.getChapterNavigation()}formatAfterEnhancement(e){super.formatAfterEnhancement(e),e.style.fontFamily="Arial, sans-serif",e.style.lineHeight="1.7",e.style.color="#bab9a0",e.querySelectorAll("p").forEach((e=>{e.style.marginBottom="1em",e.style.lineHeight="1.7",e.style.color="#bab9a0"}))}getSiteSpecificPrompt(){return"This is a machine-translated web novel from a Russian novel site. Please improve the translation while maintaining the original meaning and flow. Keep any special formatting like section breaks. Russian and Chinese names should be properly transliterated."}getSiteIdentifier(){return"Ranobes.net"}}class r{constructor(e){this.apiKey="",e&&(this.apiKey=e)}setApiKey(e){this.apiKey=e}validateApiKey(){if(!this.apiKey&&this.provider.requiresAuth)throw new Error(`API key required for ${this.provider.name}`)}async makeRequest(e,t){try{const n=await fetch(e,t);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}catch(e){throw console.error(`API request failed for ${this.provider.name}:`,e),e}}getAvailableModels(){return this.provider.models||[]}supportsFeature(e){return this.provider.features.includes(e)}getProviderInfo(){return this.provider}}class a extends r{constructor(){super(...arguments),this.provider={name:"Google Gemini",id:"gemini",apiEndpoint:"https://generativelanguage.googleapis.com/v1beta",requiresAuth:!0,authType:"api_key",features:["enhance","summarize","analyze","suggestions"],models:["gemini-pro","gemini-pro-vision","gemini-1.5-pro","gemini-1.5-flash"],defaultModel:"gemini-1.5-pro"},this.ENDPOINTS={generateContent:e=>`${this.provider.apiEndpoint}/models/${e}:generateContent`,countTokens:e=>`${this.provider.apiEndpoint}/models/${e}:countTokens`}}async enhance(e,t={}){this.validateApiKey();const{contentType:n="generic",enhancementType:r="improve",customPrompt:a,preserveFormatting:s=!0,model:i=this.provider.defaultModel||"gemini-1.5-pro"}=t;try{const t=this.buildEnhancementPrompt(e,n,r,a,s),o=await this.makeGeminiRequest(i,t);return{enhanced:this.extractTextFromResponse(o),originalLength:e.length,enhancedLength:this.extractTextFromResponse(o).length,model:i,timestamp:(new Date).toISOString()}}catch(t){return{error:`Enhancement failed: ${this.getErrorMessage(t)}`,originalContent:e}}}async summarize(e,t={}){this.validateApiKey();const{length:n="medium",style:r="comprehensive",model:a=this.provider.defaultModel||"gemini-1.5-pro"}=t,s=this.buildSummaryPrompt(e,n,r);try{const t=await this.makeGeminiRequest(a,s);return{summary:this.extractTextFromResponse(t),originalLength:e.length,compressionRatio:e.length/this.extractTextFromResponse(t).length,model:a,timestamp:(new Date).toISOString()}}catch(e){return{error:`Summary failed: ${this.getErrorMessage(e)}`}}}async makeGeminiRequest(e,t){const n=`${this.ENDPOINTS.generateContent(e)}?key=${this.apiKey}`;return await this.makeRequest(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:t}]}],generationConfig:{temperature:.7,topK:40,topP:.95,maxOutputTokens:8192}})})}extractTextFromResponse(e){return e.candidates?.[0]?.content?.parts?.[0]?.text||"No response generated"}buildEnhancementPrompt(e,t,n,r,a=!0){if(r)return`${r}\n\nContent to enhance:\n${e}`;const s={novel:"Enhance this novel/fiction content by improving readability, flow, and narrative quality while maintaining the author's voice and style.",article:"Improve this article by enhancing clarity, structure, and engagement while maintaining factual accuracy.",news:"Enhance this news content by improving clarity and readability while maintaining journalistic integrity.",technical:"Improve this technical content by enhancing clarity, accuracy, and accessibility while maintaining technical precision.",generic:"Enhance this content by improving readability, clarity, and overall quality."},i={improve:"Focus on overall improvement",grammar:"Focus primarily on grammar and syntax corrections",style:"Focus on improving writing style and flow",clarity:"Focus on making the content clearer and more understandable",expand:"Expand on ideas and add more detail where appropriate",condense:"Make the content more concise while retaining key information"};let o=`${s[t]||s.generic}. ${i[n]||i.improve}.`;return a&&(o+=" Preserve the original formatting, structure, and any special elements like dialogue, emphasis, or line breaks."),o+=`\n\nContent to enhance:\n${e}`,o}buildSummaryPrompt(e,t,n){const r={short:"Provide a brief summary in 2-3 sentences",medium:"Provide a comprehensive summary in 1-2 paragraphs",long:"Provide a detailed summary covering all key points"},a={comprehensive:"covering all main points",highlights:"focusing on the most important highlights",analytical:"with analytical insights",narrative:"maintaining the narrative flow"};return`${r[t]||r.medium} of the following content, ${a[n]||a.comprehensive}:\n\n${e}`}getErrorMessage(e){return e instanceof Error?e.message:"string"==typeof e?e:"Unknown error occurred"}async analyze(e,t){this.validateApiKey();const n=`Analyze the following content and provide insights about its structure, themes, and key points:\n\n${e}`;try{const e=await this.makeRequest(`${this.provider.apiEndpoint}/models/gemini-pro:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:n}]}]})});return{analysis:e.candidates?.[0]?.content?.parts?.[0]?.text||"No analysis available"}}catch(e){return{error:`Failed to generate analysis: ${e instanceof Error?e.message:"Unknown error"}`}}}async generateSuggestions(e,t){this.validateApiKey();const n=`Based on the following content, provide helpful suggestions for better understanding or related topics to explore:\n\n${e}`;try{const e=await this.makeRequest(`${this.provider.apiEndpoint}/models/gemini-pro:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:n}]}]})});return{suggestions:(e.candidates?.[0]?.content?.parts?.[0]?.text||"").split("\n").filter((e=>e.trim().length>0))}}catch(e){return{error:`Failed to generate suggestions: ${e instanceof Error?e.message:"Unknown error"}`}}}}class s{static countWords(e){if(!e||"string"!=typeof e)return 0;const t=e.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim();return t?t.split(/\s+/).filter((e=>e.length>0)).length:0}static countCharacters(e){return e&&"string"==typeof e?e.replace(/<[^>]*>/g,"").length:0}static calculateStats(e,t){const n=this.countWords(e),r=this.countWords(t),a=r-n,s=n>0?a/n*100:0,i=this.countCharacters(e),o=this.countCharacters(t);return{originalWords:n,enhancedWords:r,wordsChanged:a,percentageChange:Math.round(100*s)/100,charactersOriginal:i,charactersEnhanced:o}}static formatWordCount(e){return e<1e3?e.toString():e<1e6?(e/1e3).toFixed(1)+"K":(e/1e6).toFixed(1)+"M"}static formatPercentageChange(e){return`${e>0?"+":""}${e.toFixed(1)}%`}static formatWordChange(e){return`${e>0?"+":""}${this.formatWordCount(Math.abs(e))}`}static getReadingTime(e){const t=Math.round(e/200);if(t<1)return"< 1 min";if(t<60)return`${t} min`;{const e=Math.floor(t/60),n=t%60;return n>0?`${e}h ${n}m`:`${e}h`}}static extractContentWordCount(e){if(!e)return 0;const t=e.cloneNode(!0);return["nav","header","footer","aside",".ads",".navigation",".breadcrumb",".social",".share",".comments",".author-bio"].forEach((e=>{t.querySelectorAll(e).forEach((e=>e.remove()))})),this.countWords(t.textContent||"")}}class i extends r{constructor(){super(...arguments),this.provider={name:"OpenAI GPT",id:"openai",apiEndpoint:"https://api.openai.com/v1",requiresAuth:!0,authType:"api_key",features:["summarize","analyze","suggestions","keyPoints"]}}async summarize(e,t){this.validateApiKey();try{const t=await this.makeRequest(`${this.provider.apiEndpoint}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:"You are a helpful assistant that provides concise summaries of content."},{role:"user",content:`Please provide a concise summary of the following content:\n\n${e}`}],max_tokens:500,temperature:.7})});return{summary:t.choices?.[0]?.message?.content||"No summary available"}}catch(e){return{error:`Failed to generate summary: ${e instanceof Error?e.message:"Unknown error"}`}}}async analyze(e,t){this.validateApiKey();try{const t=await this.makeRequest(`${this.provider.apiEndpoint}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:"You are a helpful assistant that analyzes content and provides insights."},{role:"user",content:`Analyze the following content and provide insights about its structure, themes, and key points:\n\n${e}`}],max_tokens:800,temperature:.7})});return{analysis:t.choices?.[0]?.message?.content||"No analysis available"}}catch(e){return{error:`Failed to generate analysis: ${e instanceof Error?e.message:"Unknown error"}`}}}async generateSuggestions(e,t){this.validateApiKey();try{const t=await this.makeRequest(`${this.provider.apiEndpoint}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:"You are a helpful assistant that provides useful suggestions based on content."},{role:"user",content:`Based on the following content, provide 3-5 helpful suggestions for better understanding or related topics to explore:\n\n${e}`}],max_tokens:400,temperature:.8})});return{suggestions:(t.choices?.[0]?.message?.content||"").split("\n").filter((e=>e.trim().length>0&&(e.includes("•")||e.includes("-")||e.includes("1."))))}}catch(e){return{error:`Failed to generate suggestions: ${e instanceof Error?e.message:"Unknown error"}`}}}async enhance(e,t={}){this.validateApiKey();const{contentType:n="generic",enhancementType:r="improve",customPrompt:a,preserveFormatting:i=!0,model:o="gpt-4-turbo"}=t,c=Date.now();try{const t=this.buildEnhancementPrompt(e,n,r,a,i),l=await this.makeRequest(`${this.provider.apiEndpoint}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:o,messages:[{role:"user",content:t}],max_tokens:4096,temperature:.7})}),d=l.choices?.[0]?.message?.content||e,h=Date.now()-c,m=s.calculateStats(e,d);return{enhanced:d,originalLength:e.length,enhancedLength:d.length,model:o,timestamp:(new Date).toISOString(),processingTime:h,stats:m}}catch(t){return{error:`Enhancement failed: ${t instanceof Error?t.message:"Unknown error"}`,originalContent:e}}}buildEnhancementPrompt(e,t,n,r,a=!0){if(r)return`${r}\n\nContent to enhance:\n${e}`;const s={novel:"Enhance this novel/fiction content by improving readability, flow, and narrative quality while maintaining the author's voice and style.",article:"Improve this article by enhancing clarity, structure, and engagement while maintaining factual accuracy.",news:"Enhance this news content by improving clarity and readability while maintaining journalistic integrity.",technical:"Improve this technical content by enhancing clarity, accuracy, and accessibility while maintaining technical precision.",generic:"Enhance this content by improving readability, clarity, and overall quality."},i={improve:"Focus on overall improvement",grammar:"Focus primarily on grammar and syntax corrections",style:"Focus on improving writing style and flow",clarity:"Focus on making the content clearer and more understandable",expand:"Expand on ideas and add more detail where appropriate",condense:"Make the content more concise while retaining key information"};let o=`${s[t]||s.generic}. ${i[n]||i.improve}.`;return a&&(o+=" Preserve the original formatting, structure, and any special elements like dialogue, emphasis, or line breaks."),o+=`\n\nContent to enhance:\n${e}`,o}}class o extends r{constructor(){super(...arguments),this.provider={name:"Hugging Face",id:"huggingface",apiEndpoint:"https://api-inference.huggingface.co",requiresAuth:!0,authType:"api_key",features:["summarize","analyze"]}}async summarize(e,t){this.validateApiKey();try{const t=await this.makeRequest(`${this.provider.apiEndpoint}/models/facebook/bart-large-cnn`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({inputs:e.substring(0,1024),parameters:{max_length:200,min_length:50}})});return{summary:t[0]?.summary_text||"No summary available"}}catch(e){return{error:`Failed to generate summary: ${e instanceof Error?e.message:"Unknown error"}`}}}async analyze(e,t){this.validateApiKey();try{const t=(await this.makeRequest(`${this.provider.apiEndpoint}/models/cardiffnlp/twitter-roberta-base-sentiment-latest`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({inputs:e.substring(0,512)})}))[0];return{analysis:`Content Analysis:\n- Sentiment: ${t?.label||"Unknown"} (${(100*t?.score).toFixed(1)}% confidence)\n- Length: ${e.length} characters\n- Estimated reading time: ${Math.ceil(e.split(" ").length/200)} minutes`}}catch(e){return{error:`Failed to generate analysis: ${e instanceof Error?e.message:"Unknown error"}`}}}async generateSuggestions(e,t){return{suggestions:["Consider reading similar content on this topic","Look up key terms mentioned in the content","Check for related articles by the same author","Explore the main themes discussed"]}}async enhance(e,t={}){const n=Date.now(),{contentType:r="generic",enhancementType:a="improve",model:i="basic-cleanup"}=t;try{const t=e.replace(/\s+/g," ").replace(/\.\s+/g,". ").replace(/,\s+/g,", ").trim(),r=Date.now()-n,a=s.calculateStats(e,t);return{enhanced:t,originalLength:e.length,enhancedLength:t.length,model:i,timestamp:(new Date).toISOString(),processingTime:r,stats:a}}catch(t){return{error:`Enhancement failed: ${t instanceof Error?t.message:"Unknown error"}`,originalContent:e}}}}class c extends r{constructor(){super(...arguments),this.provider={name:"Anthropic Claude",id:"anthropic",apiEndpoint:"https://api.anthropic.com/v1",requiresAuth:!0,authType:"api_key",features:["summarize","analyze","suggestions","keyPoints"]}}async summarize(e,t){this.validateApiKey();try{const t=await this.makeRequest(`${this.provider.apiEndpoint}/messages`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:"claude-3-sonnet-20240229",max_tokens:500,messages:[{role:"user",content:`Please provide a concise summary of the following content:\n\n${e}`}]})});return{summary:t.content?.[0]?.text||"No summary available"}}catch(e){return{error:`Failed to generate summary: ${e instanceof Error?e.message:"Unknown error"}`}}}async analyze(e,t){this.validateApiKey();try{const t=await this.makeRequest(`${this.provider.apiEndpoint}/messages`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:"claude-3-sonnet-20240229",max_tokens:800,messages:[{role:"user",content:`Analyze the following content and provide insights about its structure, themes, writing style, and key points:\n\n${e}`}]})});return{analysis:t.content?.[0]?.text||"No analysis available"}}catch(e){return{error:`Failed to generate analysis: ${e instanceof Error?e.message:"Unknown error"}`}}}async generateSuggestions(e,t){this.validateApiKey();try{const t=await this.makeRequest(`${this.provider.apiEndpoint}/messages`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:"claude-3-sonnet-20240229",max_tokens:400,messages:[{role:"user",content:`Based on the following content, provide 3-5 helpful suggestions for better understanding, related topics to explore, or ways to engage with the material:\n\n${e}`}]})});return{suggestions:(t.content?.[0]?.text||"").split("\n").filter((e=>e.trim().length>0&&(e.includes("•")||e.includes("-")||/^\d+\./.test(e.trim()))))}}catch(e){return{error:`Failed to generate suggestions: ${e instanceof Error?e.message:"Unknown error"}`}}}async enhance(e,t){this.validateApiKey();const n=Date.now(),r=t?.model||"claude-3-sonnet-20240229",a=t?.customPrompt||`Enhance the following content by improving its readability, clarity, and overall quality while preserving the original meaning and style:\n\n${e}`;try{const i=await this.makeRequest(`${this.provider.apiEndpoint}/messages`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:r,max_tokens:t?.maxTokens||4096,temperature:t?.temperature||.7,messages:[{role:"user",content:a}]})}),o=i.content?.[0]?.text||e;return{enhanced:o,processingTime:Date.now()-n,stats:s.calculateStats(e,o),originalLength:e.length,enhancedLength:o.length,model:r,timestamp:(new Date).toISOString(),originalContent:e}}catch(t){return{error:`Failed to enhance content: ${t instanceof Error?t.message:"Unknown error"}`,originalContent:e}}}}class l extends r{constructor(){super(...arguments),this.provider={name:"OpenRouter",id:"openrouter",apiEndpoint:"https://openrouter.ai/api/v1",requiresAuth:!0,authType:"api_key",features:["summarize","analyze","suggestions","keyPoints"]}}async summarize(e,t){this.validateApiKey();try{const t=await this.makeRequest(`${this.provider.apiEndpoint}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,"HTTP-Referer":"https://novelsynth.com","X-Title":"NovelSynth"},body:JSON.stringify({model:"meta-llama/llama-3.2-3b-instruct:free",messages:[{role:"system",content:"You are a helpful assistant that provides concise summaries of content."},{role:"user",content:`Please provide a concise summary of the following content:\n\n${e}`}],max_tokens:500,temperature:.7})});return{summary:t.choices?.[0]?.message?.content||"No summary available"}}catch(e){return{error:`Failed to generate summary: ${e instanceof Error?e.message:"Unknown error"}`}}}async analyze(e,t){this.validateApiKey();try{const t=await this.makeRequest(`${this.provider.apiEndpoint}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,"HTTP-Referer":"https://novelsynth.com","X-Title":"NovelSynth"},body:JSON.stringify({model:"meta-llama/llama-3.2-3b-instruct:free",messages:[{role:"system",content:"You are a helpful assistant that analyzes content and provides insights."},{role:"user",content:`Analyze the following content and provide insights about its structure, themes, and key points:\n\n${e}`}],max_tokens:800,temperature:.7})});return{analysis:t.choices?.[0]?.message?.content||"No analysis available"}}catch(e){return{error:`Failed to generate analysis: ${e instanceof Error?e.message:"Unknown error"}`}}}async generateSuggestions(e,t){this.validateApiKey();try{const t=await this.makeRequest(`${this.provider.apiEndpoint}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,"HTTP-Referer":"https://novelsynth.com","X-Title":"NovelSynth"},body:JSON.stringify({model:"meta-llama/llama-3.2-3b-instruct:free",messages:[{role:"system",content:"You are a helpful assistant that provides useful suggestions based on content."},{role:"user",content:`Based on the following content, provide 3-5 helpful suggestions for better understanding or related topics to explore:\n\n${e}`}],max_tokens:400,temperature:.8})});return{suggestions:(t.choices?.[0]?.message?.content||"").split("\n").filter((e=>e.trim().length>0&&(e.includes("•")||e.includes("-")||/^\d+\./.test(e.trim()))))}}catch(e){return{error:`Failed to generate suggestions: ${e instanceof Error?e.message:"Unknown error"}`}}}async enhance(e,t={}){this.validateApiKey();const{contentType:n="generic",enhancementType:r="improve",customPrompt:a,preserveFormatting:i=!0,model:o="meta-llama/llama-3.2-3b-instruct:free"}=t,c=Date.now();try{const t=this.buildEnhancementPrompt(e,n,r,a,i),l=await this.makeRequest(`${this.provider.apiEndpoint}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,"HTTP-Referer":"https://novelsynth.com","X-Title":"NovelSynth"},body:JSON.stringify({model:o,messages:[{role:"user",content:t}],max_tokens:4096,temperature:.7})}),d=l.choices?.[0]?.message?.content||e,h=Date.now()-c,m=s.calculateStats(e,d);return{enhanced:d,originalLength:e.length,enhancedLength:d.length,model:o,timestamp:(new Date).toISOString(),processingTime:h,stats:m}}catch(t){return{error:`Enhancement failed: ${t instanceof Error?t.message:"Unknown error"}`,originalContent:e}}}buildEnhancementPrompt(e,t,n,r,a=!0){if(r)return`${r}\n\nContent to enhance:\n${e}`;const s={novel:"Enhance this novel/fiction content by improving readability, flow, and narrative quality while maintaining the author's voice and style.",article:"Improve this article by enhancing clarity, structure, and engagement while maintaining factual accuracy.",news:"Enhance this news content by improving clarity and readability while maintaining journalistic integrity.",technical:"Improve this technical content by enhancing clarity, accuracy, and accessibility while maintaining technical precision.",generic:"Enhance this content by improving readability, clarity, and overall quality."},i={improve:"Focus on overall improvement",grammar:"Focus primarily on grammar and syntax corrections",style:"Focus on improving writing style and flow",clarity:"Focus on making the content clearer and more understandable",expand:"Expand on ideas and add more detail where appropriate",condense:"Make the content more concise while retaining key information"};let o=`${s[t]||s.generic}. ${i[n]||i.improve}.`;return a&&(o+=" Preserve the original formatting, structure, and any special elements like dialogue, emphasis, or line breaks."),o+=`\n\nContent to enhance:\n${e}`,o}}class d{static canMakeRequest(e,t,n=0){const r=`${e}:${t.id}`,a=this.getTracker(r,e,t.id),s=Date.now();return s-a.lastRequest>=6e4&&(a.requestCount=0,a.tokenCount=0),!(t.rateLimitRPM&&a.requestCount>=t.rateLimitRPM)&&!(t.rateLimitTPM&&a.tokenCount+n>t.rateLimitTPM)&&s>=a.nextAvailableTime}static recordRequest(e,t,n=0){const r=`${e}:${t.id}`,a=this.getTracker(r,e,t.id),s=Date.now();if(a.requestCount++,a.tokenCount+=n,a.lastRequest=s,t.rateLimitRPM){const e=6e4/t.rateLimitRPM;a.nextAvailableTime=Math.max(a.nextAvailableTime,s+e)}}static getWaitTime(e,t){const n=`${e}:${t.id}`,r=this.getTracker(n,e,t.id),a=Date.now();return Math.max(0,r.nextAvailableTime-a)}static async waitForRateLimit(e,t){const n=this.getWaitTime(e,t);n>0&&(console.log(`Rate limit reached for ${e}:${t.id}. Waiting ${n}ms...`),await new Promise((e=>setTimeout(e,n))))}static getTracker(e,t,n){return this.trackers.has(e)||this.trackers.set(e,{provider:t,model:n,requestCount:0,tokenCount:0,lastRequest:0,nextAvailableTime:0}),this.trackers.get(e)}static clearTrackers(){this.trackers.clear()}static getTrackers(){return Array.from(this.trackers.values())}}d.trackers=new Map;class h{static segmentContent(e,t={}){const n={...this.DEFAULT_OPTIONS,...t},r=[],a=n.preserveImages?this.extractImages(e):[];let s=e;const i=[];return n.preserveImages&&a.forEach(((e,t)=>{const n=`__IMAGE_PLACEHOLDER_${t}__`;i.push(n),s=s.replace(e.originalTag,n)})),this.splitBySize(s,n.maxChunkSize,n.overlapSize).forEach(((e,t)=>{let s=e.content;const o=[];n.preserveImages&&i.forEach(((e,t)=>{if(s.includes(e)){const n=a[t];s=s.replace(e,n.originalTag),o.push({...n,position:s.indexOf(n.originalTag)})}})),r.push({id:`segment_${t}`,content:s,startIndex:e.startIndex,endIndex:e.endIndex,preserveImages:n.preserveImages,imagePositions:o})})),r}static reassembleSegments(e){const t=e.sort(((e,t)=>e.startIndex-t.startIndex));let n="",r=0;return t.forEach(((e,t)=>{if(0===t)n=e.content,r=e.endIndex;else{const t=Math.max(0,r-e.startIndex),a=t>0?e.content.substring(t):e.content;n+=a,r=e.endIndex}})),n}static extractImages(e){const t=[],n=/<img[^>]*>/gi;let r;for(;null!==(r=n.exec(e));){const e=r[0],n=e.match(/src=["']([^"']*)["']/i),a=e.match(/alt=["']([^"']*)["']/i),s=e.match(/title=["']([^"']*)["']/i);n&&t.push({src:n[1],alt:a?a[1]:void 0,title:s?s[1]:void 0,position:r.index,originalTag:e})}return t}static splitBySize(e,t,n){const r=[];if(e.length<=t)return[{content:e,startIndex:0,endIndex:e.length}];let a=0;for(;a<e.length;){const s=Math.min(a+t,e.length);let i=s;if(s<e.length){const t=Math.max(a,s-500),n=this.findLastSentenceBreak(e,t,s);n>a&&(i=n)}const o=e.substring(a,i);r.push({content:o,startIndex:a,endIndex:i}),a=Math.max(a+1,i-n)}return r}static findLastSentenceBreak(e,t,n){const r=e.substring(t,n);let a=-1;return[". ","! ","? ",".\n","!\n","?\n"].forEach((e=>{const t=r.lastIndexOf(e);t>a&&(a=t+e.length)})),a>-1?t+a:n}}var m,g;h.DEFAULT_OPTIONS={maxChunkSize:12e3,preserveImages:!0,preserveFormatting:!0,overlapSize:200},function(e){e.NOVEL="novel",e.ARTICLE="article",e.NEWS="news",e.TECHNICAL="technical",e.GENERIC="generic"}(m||(m={})),function(e){e.ENHANCEMENT="enhancement",e.SUMMARY="summary",e.PERMANENT="permanent",e.WEBSITE="website",e.NOVEL="novel"}(g||(g={})),m.NOVEL,m.ARTICLE,m.NEWS,m.TECHNICAL,m.GENERIC,m.NOVEL,m.ARTICLE,m.NEWS,m.TECHNICAL,m.GENERIC;const u={gemini:[{id:"gemini-1.5-pro",name:"Gemini 1.5 Pro",maxTokens:2097152},{id:"gemini-1.5-flash",name:"Gemini 1.5 Flash",maxTokens:1048576},{id:"gemini-pro",name:"Gemini Pro",maxTokens:32768}],openai:[{id:"gpt-4-turbo",name:"GPT-4 Turbo",maxTokens:128e3},{id:"gpt-4",name:"GPT-4",maxTokens:32768},{id:"gpt-3.5-turbo",name:"GPT-3.5 Turbo",maxTokens:16384}],anthropic:[{id:"claude-3-opus-20240229",name:"Claude 3 Opus",maxTokens:2e5},{id:"claude-3-sonnet-20240229",name:"Claude 3 Sonnet",maxTokens:2e5},{id:"claude-3-haiku-20240307",name:"Claude 3 Haiku",maxTokens:2e5}],huggingface:[{id:"microsoft/DialoGPT-large",name:"DialoGPT Large",maxTokens:1024},{id:"facebook/blenderbot-400M-distill",name:"BlenderBot 400M",maxTokens:512}],openrouter:[{id:"meta-llama/llama-3.2-3b-instruct:free",name:"Llama 3.2 3B (Free)",maxTokens:32768},{id:"microsoft/wizardlm-2-8x22b",name:"WizardLM-2 8x22B",maxTokens:65536},{id:"anthropic/claude-3.5-sonnet",name:"Claude 3.5 Sonnet",maxTokens:2e5}]};m.NOVEL,m.TECHNICAL,m.NEWS,m.ARTICLE;class p{constructor(){this.services=new Map,this.currentService=null,this.currentSettings=null,this.initializeServices()}initializeServices(){[new a,new i,new o,new c,new l].forEach((e=>{this.services.set(e.provider.id,e)}))}getAvailableProviders(){return Array.from(this.services.values()).map((e=>e.provider))}getAvailableModels(e){return u[e]||[]}getAllAvailableModels(){const e={};return this.getAvailableProviders().forEach((t=>{e[t.id]=this.getAvailableModels(t.id)})),e}async setActiveProvider(e,t){const n=this.services.get(e);return n?(t&&n.setApiKey(t),this.currentService=n,!0):(console.error(`AI provider '${e}' not found`),!1)}getCurrentProvider(){return this.currentService?.provider||null}async enhance(e,t={},n="enhance"){if(!this.currentService||!this.currentSettings)return{error:"No AI provider selected or settings not loaded"};try{const r=this.currentSettings.selectedModels[n],a=this.getModelById(this.currentService.provider.id,r);if(!a)return{error:`Model ${r} not found for provider ${this.currentService.provider.id}`};const s={...t,model:a.id};return e.length>3*a.maxTokens?await this.enhanceWithSegmentation(e,s,a):await this.enhanceSingleContent(e,s,a)}catch(e){return{error:`Service error: ${e instanceof Error?e.message:"Unknown error"}`}}}async enhanceWithSegmentation(e,t,n){const r=h.segmentContent(e,{maxChunkSize:Math.floor(2.5*n.maxTokens),preserveImages:!0,preserveFormatting:!0}),a=[];let s=0,i=!1,o="";for(const e of r){this.currentSettings?.rateLimiting.enabled&&await d.waitForRateLimit(this.currentService.provider.id,n);const c={...t,customPrompt:t.customPrompt?`${t.customPrompt}\n\n**Important:** This is part ${r.indexOf(e)+1} of ${r.length} segments. Maintain consistency with the overall content style and formatting.`:`**Important:** This is part ${r.indexOf(e)+1} of ${r.length} segments. Maintain consistency with the overall content style and formatting.`};try{const t=await this.currentService.enhance(e.content,c);if(t.error){i=!0,o=t.error;break}a.push({...e,content:t.enhanced||e.content}),s+=t.processingTime||0,d.recordRequest(this.currentService.provider.id,n)}catch(e){i=!0,o=e instanceof Error?e.message:"Unknown error";break}}return i?{error:o}:{enhanced:h.reassembleSegments(a),processingTime:s}}async enhanceSingleContent(e,t,n){this.currentSettings?.rateLimiting.enabled&&await d.waitForRateLimit(this.currentService.provider.id,n);try{const r=await this.currentService.enhance(e,t);return d.recordRequest(this.currentService.provider.id,n),r}catch(e){return{error:`Enhancement failed: ${e instanceof Error?e.message:"Unknown error"}`}}}getModelById(e,t){return this.getAvailableModels(e).find((e=>e.id===t))||null}async summarize(e,t){if(!this.currentService||!this.currentSettings)return{error:"No AI provider selected or settings not loaded"};try{const n=this.currentSettings.selectedModels.summarize,r=this.getModelById(this.currentService.provider.id,n);if(!r)return{error:`Model ${n} not found`};this.currentSettings.rateLimiting.enabled&&await d.waitForRateLimit(this.currentService.provider.id,r);const a=await this.currentService.summarize(e,{...t,model:r.id});return d.recordRequest(this.currentService.provider.id,r),a}catch(e){return{error:`Service error: ${e instanceof Error?e.message:"Unknown error"}`}}}async analyze(e,t){if(!this.currentService||!this.currentSettings)return{error:"No AI provider selected or settings not loaded"};try{const n=this.currentSettings.selectedModels.analyze,r=this.getModelById(this.currentService.provider.id,n);if(!r)return{error:`Model ${n} not found`};this.currentSettings.rateLimiting.enabled&&await d.waitForRateLimit(this.currentService.provider.id,r);const a=await this.currentService.analyze(e,{...t,model:r.id});return d.recordRequest(this.currentService.provider.id,r),a}catch(e){return{error:`Service error: ${e instanceof Error?e.message:"Unknown error"}`}}}async generateSuggestions(e,t){if(!this.currentService||!this.currentSettings)return{error:"No AI provider selected or settings not loaded"};try{const n=this.currentSettings.selectedModels.suggestions,r=this.getModelById(this.currentService.provider.id,n);if(!r)return{error:`Model ${n} not found`};this.currentSettings.rateLimiting.enabled&&await d.waitForRateLimit(this.currentService.provider.id,r);const a=await this.currentService.generateSuggestions(e,{...t,model:r.id});return d.recordRequest(this.currentService.provider.id,r),a}catch(e){return{error:`Service error: ${e instanceof Error?e.message:"Unknown error"}`}}}async loadSettingsAndInitialize(e){this.currentSettings=e;const{selectedProvider:t,apiKeys:n}=e;if(t&&n[t])await this.setActiveProvider(t,n[t]);else{const e=this.getAvailableProviders();e.length>0&&await this.setActiveProvider(e[0].id)}}}class y{constructor(){this.currentHandler=null,this.aiServiceManager=new p,this.detectWebsiteHandler()}detectWebsiteHandler(){const r=window.location.hostname.toLowerCase();r.includes("fanfiction.net")?this.currentHandler=new t:r.includes("ranobes.net")||r.includes("ranobes.com")||r.includes("ranobes.top")?this.currentHandler=new n:this.currentHandler=new e}canHandleCurrentPage(){return null!==this.currentHandler&&null!==this.currentHandler.findContentArea()}async processCurrentPage(e={}){try{if(!this.currentHandler)return{success:!1,error:"No suitable handler found for this website"};const t=this.currentHandler.findContentArea();if(!t)return{success:!1,error:"No content area found on this page"};const n=this.currentHandler.extractContent(t);if(!n||n.trim().length<100)return{success:!1,error:"Content too short or empty"};const r=this.detectContentType(),a={contentType:r,enhancementType:e.enhancementType||"improve",preserveFormatting:!1!==e.preserveFormatting,...e},s=await this.aiServiceManager.enhance(n,a);return s.error?{success:!1,error:s.error}:{success:!0,originalContent:n,enhancedContent:s.enhanced||"",metadata:{title:this.currentHandler.extractTitle(),contentType:r,timestamp:(new Date).toISOString(),wordCount:n.split(/\s+/).length,enhancementType:a.enhancementType}}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}replacePageContent(e){if(!this.currentHandler)return void console.error("No handler available to replace content");const t=this.currentHandler.findContentArea();t?(t.dataset.originalContent||(t.dataset.originalContent=t.innerHTML),t.innerHTML=this.formatContentForDisplay(e),this.currentHandler.formatAfterEnhancement(t)):console.error("No content area found to replace")}detectContentType(){const e=window.location.hostname.toLowerCase();return e.includes("fanfiction")||e.includes("archiveofourown")||e.includes("wattpad")||e.includes("royalroad")?"novel":e.includes("news")||e.includes("article")?"news":"generic"}formatContentForDisplay(e){return e.replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>").replace(/^/,"<p>").replace(/$/,"</p>")}getCurrentHandler(){return this.currentHandler}}class v{static async getSettings(){try{const e=(await chrome.storage.sync.get(this.STORAGE_KEY))[this.STORAGE_KEY];return e?{...this.DEFAULT_SETTINGS,...e}:this.DEFAULT_SETTINGS}catch(e){return console.error("Failed to load settings:",e),this.DEFAULT_SETTINGS}}static async saveSettings(e){try{const t={...await this.getSettings(),...e};return await chrome.storage.sync.set({[this.STORAGE_KEY]:t}),!0}catch(e){return console.error("Failed to save settings:",e),!1}}static async updateApiKey(e,t){try{const n=await this.getSettings();return n.apiKeys[e]=t,await this.saveSettings(n)}catch(e){return console.error("Failed to update API key:",e),!1}}static async removeApiKey(e){try{const t=await this.getSettings();return delete t.apiKeys[e],await this.saveSettings(t)}catch(e){return console.error("Failed to remove API key:",e),!1}}static async setSelectedProvider(e){return await this.saveSettings({selectedProvider:e})}static async setSelectedModel(e,t){try{const n={...(await this.getSettings()).selectedModels,[e]:t};return await this.saveSettings({selectedModels:n})}catch(e){return console.error("Failed to set selected model:",e),!1}}static async setSelectedModels(e){try{const t={...(await this.getSettings()).selectedModels,...e};return await this.saveSettings({selectedModels:t})}catch(e){return console.error("Failed to set selected models:",e),!1}}static async setCustomPrompt(e,t,n){try{const r=(await this.getSettings()).customPrompts||{enhancement:{},summary:{},permanent:{},website:{},novel:{}},a={...r};return a[e]={...r[e],[t]:n},await this.saveSettings({customPrompts:a})}catch(e){return console.error("Failed to set custom prompt:",e),!1}}static async removeCustomPrompt(e,t){try{const n=await this.getSettings();if(!n.customPrompts)return!0;const r={...n.customPrompts};return r[e]={...n.customPrompts[e]},delete r[e][t],await this.saveSettings({customPrompts:r})}catch(e){return console.error("Failed to remove custom prompt:",e),!1}}static async setRateLimitingSettings(e){try{const t={...(await this.getSettings()).rateLimiting,...e};return await this.saveSettings({rateLimiting:t})}catch(e){return console.error("Failed to set rate limiting settings:",e),!1}}static async setContentDetectionSettings(e){return await this.saveSettings(e)}static async toggleFeature(e){try{const t=[...(await this.getSettings()).enabledFeatures],n=t.indexOf(e);return n>=0?t.splice(n,1):t.push(e),await this.saveSettings({enabledFeatures:t})}catch(e){return console.error("Failed to toggle feature:",e),!1}}static async toggleHandler(e){try{const t=[...(await this.getSettings()).enabledHandlers],n=t.indexOf(e);return n>=0?t.splice(n,1):t.push(e),await this.saveSettings({enabledHandlers:t})}catch(e){return console.error("Failed to toggle handler:",e),!1}}static async clearAllData(){try{return await chrome.storage.sync.remove(this.STORAGE_KEY),!0}catch(e){return console.error("Failed to clear data:",e),!1}}static onSettingsChanged(e){chrome.storage.onChanged.addListener(((t,n)=>{if("sync"===n&&t[this.STORAGE_KEY]){const n=t[this.STORAGE_KEY].newValue;n&&e({...this.DEFAULT_SETTINGS,...n})}}))}static async storeContent(e,t,n,r){try{const a={pageUrl:e,originalContent:t,enhancedContent:n,timestamp:Date.now(),contentHash:this.generateContentHash(t),contentType:r.contentType,websiteId:r.websiteId},s=await this.getStoredContent();s[e]=a;const i=Object.entries(s);if(i.length>50){const e=i.sort(((e,t)=>t[1].timestamp-e[1].timestamp)),t=Object.fromEntries(e.slice(0,50));await chrome.storage.local.set({[this.CONTENT_STORAGE_KEY]:t})}else await chrome.storage.local.set({[this.CONTENT_STORAGE_KEY]:s});return!0}catch(e){return console.error("Failed to store content:",e),!1}}static async getStoredContentForUrl(e){try{return(await this.getStoredContent())[e]||null}catch(e){return console.error("Failed to retrieve content:",e),null}}static async getStoredContent(){try{return(await chrome.storage.local.get(this.CONTENT_STORAGE_KEY))[this.CONTENT_STORAGE_KEY]||{}}catch(e){return console.error("Failed to get stored content:",e),{}}}static async clearStoredContent(e){try{if(e){const t=await this.getStoredContent();delete t[e],await chrome.storage.local.set({[this.CONTENT_STORAGE_KEY]:t})}else await chrome.storage.local.remove(this.CONTENT_STORAGE_KEY);return!0}catch(e){return console.error("Failed to clear stored content:",e),!1}}static async getStorageStats(){try{const e=await this.getStoredContent(),t=Object.values(e),n=JSON.stringify(e).length,r=t.length,a=t.reduce(((e,t)=>t.timestamp<e.timestamp?t:e),t[0]),s=t.reduce(((e,t)=>t.timestamp>e.timestamp?t:e),t[0]);return{totalSize:n,totalItems:r,oldestItem:a?.timestamp||void 0,newestItem:s?.timestamp||void 0}}catch(e){return console.error("Failed to get storage stats:",e),{totalSize:0,totalItems:0}}}static async setToggleState(e,t){try{const n=await this.getToggleStates(),r=await this.getStoredContentForUrl(e);return n[e]={isShowingEnhanced:t,hasEnhancedContent:!!r?.enhancedContent,hasSummary:!!r?.summary,isProcessing:!1},await chrome.storage.local.set({novelsynth_toggle_states:n}),!0}catch(e){return console.error("Failed to set toggle state:",e),!1}}static async getToggleState(e){try{return(await this.getToggleStates())[e]||null}catch(e){return console.error("Failed to get toggle state:",e),null}}static async getToggleStates(){try{return(await chrome.storage.local.get("novelsynth_toggle_states")).novelsynth_toggle_states||{}}catch(e){return console.error("Failed to get toggle states:",e),{}}}static generateContentHash(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t&=t;return Math.abs(t).toString(16)}}v.STORAGE_KEY="novelsynth_settings",v.CONTENT_STORAGE_KEY="novelsynth_content",v.DEFAULT_SETTINGS={selectedProvider:"gemini",selectedModels:{enhance:"gemini-1.5-flash",summarize:"gemini-1.5-flash",analyze:"gemini-1.5-flash",suggestions:"gemini-1.5-flash"},apiKeys:{},enabledFeatures:["summarize","analyze","suggestions","enhance"],enabledHandlers:["FanFiction.Net","Archive of Our Own","Royal Road","WebNovel.com","GeeksforGeeks","Medium","Generic News"],theme:"auto",customPrompts:{enhancement:{},summary:{},permanent:{},website:{},novel:{}},autoDetectContentType:!0,showWordCount:!0,showProcessingBanner:!0,rateLimiting:{enabled:!0,waitTime:1e3,retryAttempts:3}};class f{constructor(e){this.bannerElement=null,this.config=e,this.currentUrl=window.location.href}showInitialBanner(e,t){if(!this.config.showProcessingBanner)return;this.removeBanner();const n=this.createBannerElement(),r=s.getReadingTime(t);n.innerHTML=`\n      <div class="novelsynth-banner-content">\n        <div class="novelsynth-banner-header">\n          <span class="novelsynth-banner-title">📖 NovelSynth Ready</span>\n          <span class="novelsynth-banner-close" title="Close">&times;</span>\n        </div>\n        <div class="novelsynth-banner-stats">\n          <div class="stat-item">\n            <span class="stat-label">Words:</span>\n            <span class="stat-value">${s.formatWordCount(t)}</span>\n          </div>\n          <div class="stat-item">\n            <span class="stat-label">Reading Time:</span>\n            <span class="stat-value">${r}</span>\n          </div>\n          <div class="stat-item">\n            <span class="stat-label">AI Provider:</span>\n            <span class="stat-value">${this.config.provider}</span>\n          </div>\n          <div class="stat-item">\n            <span class="stat-label">Model:</span>\n            <span class="stat-value">${this.config.model}</span>\n          </div>\n        </div>\n      </div>\n    `,this.insertBanner(e,n),this.setupBannerEvents(n)}showProcessingBanner(e){if(!this.config.showProcessingBanner)return;this.removeBanner();const t=this.createBannerElement();t.classList.add("processing"),t.innerHTML=`\n      <div class="novelsynth-banner-content">\n        <div class="novelsynth-banner-header">\n          <span class="novelsynth-banner-title">🤖 Enhancing Content...</span>\n          <div class="novelsynth-spinner"></div>\n        </div>\n        <div class="novelsynth-banner-stats">\n          <div class="stat-item">\n            <span class="stat-label">AI Provider:</span>\n            <span class="stat-value">${this.config.provider}</span>\n          </div>\n          <div class="stat-item">\n            <span class="stat-label">Model:</span>\n            <span class="stat-value">${this.config.model}</span>\n          </div>\n          <div class="stat-item">\n            <span class="stat-label">Status:</span>\n            <span class="stat-value processing-text">Processing...</span>\n          </div>\n        </div>\n      </div>\n    `,this.insertBanner(e,t)}showCompletionBanner(e,t,n){if(!this.config.showProcessingBanner)return;this.removeBanner();const r=this.createBannerElement();r.classList.add("completed");const a=t.wordsChanged>=0?"positive":"negative",i=t.wordsChanged>=0?"📈":"📉";r.innerHTML=`\n      <div class="novelsynth-banner-content">\n        <div class="novelsynth-banner-header">\n          <span class="novelsynth-banner-title">✨ Enhancement Complete</span>\n          <span class="novelsynth-banner-close" title="Close">&times;</span>\n        </div>\n        <div class="novelsynth-banner-stats">\n          <div class="stat-item">\n            <span class="stat-label">Original Words:</span>\n            <span class="stat-value">${s.formatWordCount(t.originalWords)}</span>\n          </div>\n          <div class="stat-item">\n            <span class="stat-label">Enhanced Words:</span>\n            <span class="stat-value">${s.formatWordCount(t.enhancedWords)}</span>\n          </div>\n          <div class="stat-item">\n            <span class="stat-label">Change:</span>\n            <span class="stat-value ${a}">\n              ${i} ${s.formatWordChange(t.wordsChanged)}\n              (${s.formatPercentageChange(t.percentageChange)})\n            </span>\n          </div>\n          <div class="stat-item">\n            <span class="stat-label">Processing Time:</span>\n            <span class="stat-value">${(n/1e3).toFixed(1)}s</span>\n          </div>\n          <div class="stat-item">\n            <span class="stat-label">Provider:</span>\n            <span class="stat-value">${this.config.provider} (${this.config.model})</span>\n          </div>\n        </div>\n      </div>\n    `,this.insertBanner(e,r),this.setupBannerEvents(r),setTimeout((()=>{this.removeBanner()}),1e4)}showErrorBanner(e,t){if(!this.config.showProcessingBanner)return;this.removeBanner();const n=this.createBannerElement();n.classList.add("error"),n.innerHTML=`\n      <div class="novelsynth-banner-content">\n        <div class="novelsynth-banner-header">\n          <span class="novelsynth-banner-title">❌ Enhancement Failed</span>\n          <span class="novelsynth-banner-close" title="Close">&times;</span>\n        </div>\n        <div class="novelsynth-banner-error">\n          <p>${t}</p>\n        </div>\n      </div>\n    `,this.insertBanner(e,n),this.setupBannerEvents(n),setTimeout((()=>{this.removeBanner()}),8e3)}async showToggleBanner(e,t=!1,n=!1){if(!this.config.showProcessingBanner)return;this.removeBanner();const r=await v.getToggleState(this.currentUrl),a=r?.isShowingEnhanced||!1,s=this.createBannerElement();s.classList.add("toggle-banner"),s.innerHTML=`\n      <div class="novelsynth-banner-content">\n        <div class="novelsynth-banner-header">\n          <span class="novelsynth-banner-title">📖 NovelSynth Content</span>\n          <div class="novelsynth-banner-actions">\n            <button\n              class="novelsynth-toggle-btn ${a?"":"active"}"\n              data-view="original"\n              ${t?"":"disabled"}\n              title="Show original content"\n            >\n              Original\n            </button>\n            <button\n              class="novelsynth-toggle-btn ${a?"active":""}"\n              data-view="enhanced"\n              ${t?"":"disabled"}\n              title="Show enhanced content"\n            >\n              Enhanced\n            </button>\n            ${n?'\n              <button\n                class="novelsynth-toggle-btn"\n                data-view="summary"\n                title="Show summary"\n              >\n                Summary\n              </button>\n            ':""}\n            <span class="novelsynth-banner-close" title="Close">&times;</span>\n          </div>\n        </div>\n        <div class="novelsynth-banner-status">\n          <div class="status-indicator">\n            <span class="status-label">Current View:</span>\n            <span class="status-value">${a?"Enhanced":"Original"}</span>\n          </div>\n          <div class="status-indicator">\n            <span class="status-label">Provider:</span>\n            <span class="status-value">${this.config.provider}</span>\n          </div>\n          <div class="status-indicator">\n            <span class="status-label">Model:</span>\n            <span class="status-value">${this.config.model}</span>\n          </div>\n        </div>\n      </div>\n    `,this.insertBanner(e,s),this.setupToggleBannerEvents(s,e)}setupToggleBannerEvents(e,t){const n=e.querySelector(".novelsynth-banner-close");n&&n.addEventListener("click",(()=>{this.removeBanner()}));const r=e.querySelectorAll(".novelsynth-toggle-btn");r.forEach((n=>{n.addEventListener("click",(async n=>{const a=n.target,s=a.dataset.view;a.disabled||(r.forEach((e=>e.classList.remove("active"))),a.classList.add("active"),await this.handleContentToggle(s,t),this.updateStatusDisplay(e,s))}))}))}async handleContentToggle(e,t){if(!e)return;const n=await v.getStoredContentForUrl(this.currentUrl);if(n)try{let r="",a=!1;switch(e){case"original":r=n.originalContent,a=!1;break;case"enhanced":r=n.enhancedContent||n.originalContent,a=!0;break;case"summary":r=n.summary||"Summary not available",a=!1;break;default:return}t&&(t.innerHTML=r),await v.setToggleState(this.currentUrl,a),window.dispatchEvent(new CustomEvent("novelsynth:contentToggled",{detail:{view:e,isShowingEnhanced:a}}))}catch(e){console.error("Failed to toggle content:",e),this.showErrorBanner(t,"Failed to switch content view")}}updateStatusDisplay(e,t){const n=e.querySelector(".status-value");if(n&&t){const e={original:"Original",enhanced:"Enhanced",summary:"Summary"};n.textContent=e[t]||"Unknown"}}async checkAndUpdateBanner(e){const t=await v.getStoredContentForUrl(this.currentUrl),n=!!t?.enhancedContent,r=!!t?.summary;(n||r)&&await this.showToggleBanner(e,n,r)}removeBanner(){this.bannerElement&&(this.bannerElement.remove(),this.bannerElement=null)}createBannerElement(){const e=document.createElement("div");return e.className="novelsynth-processing-banner",e.innerHTML=this.getBannerStyles(),e}insertBanner(e,t){(e.parentElement||document.body).insertBefore(t,e),this.bannerElement=t}setupBannerEvents(e){const t=e.querySelector(".novelsynth-banner-close");t&&t.addEventListener("click",(()=>{this.removeBanner()}))}getBannerStyles(){return"\n      <style>\n        .novelsynth-processing-banner {\n          position: relative;\n          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n          color: white;\n          padding: 16px 20px;\n          margin: 16px 0;\n          border-radius: 12px;\n          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n          z-index: 10000;\n          border: 2px solid rgba(255, 255, 255, 0.1);\n        }\n\n        .novelsynth-processing-banner.processing {\n          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n          animation: processingPulse 2s infinite;\n        }\n\n        .novelsynth-processing-banner.completed {\n          background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);\n        }\n\n        .novelsynth-processing-banner.error {\n          background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);\n        }\n\n        .novelsynth-processing-banner.toggle-banner {\n          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n        }\n\n        @keyframes processingPulse {\n          0%, 100% { opacity: 1; }\n          50% { opacity: 0.8; }\n        }\n\n        .novelsynth-banner-content {\n          max-width: 100%;\n        }\n\n        .novelsynth-banner-header {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          margin-bottom: 12px;\n        }\n\n        .novelsynth-banner-title {\n          font-size: 16px;\n          font-weight: 600;\n          margin: 0;\n        }\n\n        .novelsynth-banner-close {\n          cursor: pointer;\n          font-size: 20px;\n          font-weight: bold;\n          opacity: 0.7;\n          transition: opacity 0.2s;\n          padding: 0 4px;\n        }\n\n        .novelsynth-banner-close:hover {\n          opacity: 1;\n        }\n\n        .novelsynth-banner-stats {\n          display: grid;\n          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n          gap: 12px;\n          margin-bottom: 8px;\n        }\n\n        .stat-item {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          background: rgba(255, 255, 255, 0.1);\n          padding: 8px 12px;\n          border-radius: 6px;\n          backdrop-filter: blur(10px);\n        }\n\n        .stat-label {\n          font-size: 13px;\n          opacity: 0.9;\n          font-weight: 500;\n        }\n\n        .stat-value {\n          font-size: 13px;\n          font-weight: 600;\n        }\n\n        .stat-value.positive {\n          color: #4ade80;\n        }\n\n        .stat-value.negative {\n          color: #f87171;\n        }\n\n        .processing-text {\n          animation: processingDots 1.5s infinite;\n        }\n\n        @keyframes processingDots {\n          0% { content: 'Processing'; }\n          33% { content: 'Processing.'; }\n          66% { content: 'Processing..'; }\n          100% { content: 'Processing...'; }\n        }\n\n        .novelsynth-spinner {\n          width: 16px;\n          height: 16px;\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-top: 2px solid white;\n          border-radius: 50%;\n          animation: spin 1s linear infinite;\n        }\n\n        @keyframes spin {\n          0% { transform: rotate(0deg); }\n          100% { transform: rotate(360deg); }\n        }\n\n        .novelsynth-banner-error {\n          background: rgba(255, 255, 255, 0.1);\n          padding: 12px;\n          border-radius: 6px;\n          margin-top: 8px;\n        }\n\n        .novelsynth-banner-error p {\n          margin: 0;\n          font-size: 14px;\n          line-height: 1.4;\n        }\n\n        .novelsynth-banner-actions {\n          display: flex;\n          gap: 8px;\n        }\n\n        .novelsynth-toggle-btn {\n          background: rgba(255, 255, 255, 0.1);\n          color: white;\n          border: none;\n          padding: 8px 12px;\n          border-radius: 6px;\n          cursor: pointer;\n          font-size: 13px;\n          font-weight: 500;\n          transition: background 0.2s, opacity 0.2s;\n        }\n\n        .novelsynth-toggle-btn.active {\n          background: rgba(255, 255, 255, 0.3);\n        }\n\n        .novelsynth-toggle-btn:disabled {\n          opacity: 0.5;\n          cursor: not-allowed;\n        }\n\n        .novelsynth-banner-status {\n          display: flex;\n          flex-direction: column;\n          gap: 8px;\n          margin-top: 12px;\n        }\n\n        .status-indicator {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          background: rgba(255, 255, 255, 0.1);\n          padding: 8px 12px;\n          border-radius: 6px;\n        }\n\n        .status-label {\n          font-size: 13px;\n          opacity: 0.9;\n          font-weight: 500;\n        }\n\n        .status-value {\n          font-size: 13px;\n          font-weight: 600;\n        }\n\n        @media (max-width: 768px) {\n          .novelsynth-banner-stats {\n            grid-template-columns: 1fr;\n          }\n\n          .novelsynth-processing-banner {\n            margin: 8px;\n            padding: 12px 16px;\n          }\n        }\n      </style>\n    "}}class w{constructor(){this.processingBanner=null,this.isProcessing=!1,this.contentProcessor=new y,this.init()}async init(){await this.restoreEnhancedContent(),this.setupMessageListeners(),this.autoDetectContent()}setupMessageListeners(){chrome.runtime.onMessage.addListener(((e,t,n)=>{switch(e.action){case"enhanceContent":this.handleEnhanceContent(e.options),n({success:!0});break;case"toggleContent":this.handleToggleContent(),n({success:!0});break;case"getContentStatus":n({hasEnhanced:this.hasEnhancedContent(),isProcessing:this.isProcessing})}return!0}))}async restoreEnhancedContent(){try{const e=window.location.href,t=(await v.getStoredContent())[e];t&&t.enhancedContent&&this.showToggleBanner()}catch(e){console.error("Failed to restore enhanced content:",e)}}async handleEnhanceContent(e={}){if(this.isProcessing)console.log("Enhancement already in progress");else try{this.isProcessing=!0;const t={provider:"gemini",model:"gemini-1.5-pro",showWordCount:!0,showProcessingBanner:!0};this.processingBanner=new f(t);const n=await this.contentProcessor.processCurrentPage(e);if(n.success&&n.enhancedContent){const e=window.location.href,r=n.originalContent||"",a=n.enhancedContent,s=n.metadata,i={timestamp:(new Date).toISOString(),provider:t.provider,model:t.model,contentType:s?.contentType||"generic"};s?.websiteId&&(i.websiteId=s.websiteId),s?.processingTime&&(i.processingTime=s.processingTime),await v.storeContent(e,r,a,i),this.showToggleBanner()}else console.error("Enhancement failed:",n.error)}catch(e){console.error("Enhancement error:",e)}finally{this.isProcessing=!1}}showToggleBanner(){this.processingBanner,this.processingBanner=new f({provider:"gemini",model:"gemini-1.5-pro",showWordCount:!0,showProcessingBanner:!0})}async handleToggleContent(){try{const e=window.location.href,t=(await v.getStoredContent())[e];if(!t)return void console.error("No stored content found for toggle");t.enhancedContent&&this.contentProcessor.replacePageContent(t.enhancedContent),console.log("Toggle content executed (placeholder logic)")}catch(e){console.error("Failed to toggle content:",e)}}async handleRemoveEnhancement(){try{const e=window.location.href,t=(await v.getStoredContent())[e];t&&t.originalContent&&this.contentProcessor.replacePageContent(t.originalContent),await v.clearStoredContent(e),this.processingBanner&&(this.processingBanner=null),console.log("Enhancement removed, original content restored")}catch(e){console.error("Failed to remove enhancement:",e)}}hasEnhancedContent(){return null!==this.processingBanner}autoDetectContent(){chrome.storage.sync.get(["autoEnhance"],(e=>{e.autoEnhance&&this.contentProcessor.canHandleCurrentPage()&&setTimeout((()=>{this.handleEnhanceContent({auto:!0})}),2e3)}))}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{new w})):new w})();